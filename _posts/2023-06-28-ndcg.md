---
title: Ranking算法评估指标：NDCG
tags: [机器学习,搜索,算法]
article_header:
  type: cover
---
在搜索系统排序任务中，评估排序质量是至关重要的。NDCG（Normalized Discounted Cumulative Gain）指标作为一种常用的排序评价指标，能够量化排序结果与理想排序之间的差距。本文将介绍NDCG指标的定义、计算方法以及其在实际应用中的重要性。
<!--more-->

### 1.为什么要评估排序？
排序问题对于任何一个计算机领域的从业者来说是老熟人了，解决排序问题的算法也有很多，
诸如冒泡排序算法，快速排序算法，归并排序算法等等。这些算法应用的场景都是在已知一个显式的数组的情况下，返回最佳排序。
例如给定一个数组$$[1,3,5,2,4]$$， 我们熟知的各种排序算法都会给我们一个最理想的排序$$[5,4,3,2,1]$$。
在这种场景下，我们当然没有评估排序的必要，因为最理想的排序是显而易见的。

但在实际应用场景下，例如搜索场景的Ranking任务中，每个元素的排序依据值对于我们是隐式的，我们无法预先知道最理想的排序。
举个例子，想象这样一个场景，我们经营了一家美妆商店，仓库中有5支不同品牌的口红，一位用户通过我们的APP搜索口红，在用户的搜索结果页中这五支口红该以什么顺序出现呢？
（实际场景中，我们需要考虑口红的价格，用户的品牌偏好等等因素以达成商店的收益最大化)。这里为了简化问题方便讨论，我们假设每支口红都有一个隐式的价值评分。
我们最理想的情况是将口红按照这个隐式的价值评分倒排。评分越高的商品占据越靠前的宝贵的曝光位，评分低的商品暂时放到靠后的位置。但由于价值评分是隐式的，工程师研发的排序算法只能综合各方面因素进行猜测，给出一个排序。
这时候我们为了评估排序算法的价值，就需要一个标准来对排序的效果进行排序，从而确定离最理想的情况还有多少差距。

比如最理想的口红排序是$$[5,4,3,2,1]$$,但是算法A给出了$$[5,1,3,2,4]$$， 算法B给出了$$[5,3,4,2,1]$$，哪个排序更优呢？只有知道了哪个更好，哪个更差，机器学习算法才能够开始根据现有样本进行拟合。

所以确定一个标准来衡量排序的质量是非常重要的。

### 2. 如何评估排序？
仍然关注我们之前提到的例子，第$$i$$个口红拥有一个隐藏的价值评分$$ItemScore_i$$，这里我们称这个评分为$$Gain$$，这个评分当然是越高越好，我们期望用户在更靠前的位置看到的商品具有更高的价值评分，用户才更有可能购买这个商品。（注意，此处的价值评分，不是指商品的价格，用户并不一定会购买更贵的商品，这里的价值评分如前所述，是为了方便讨论问题而假设的一个因子，在一些经典的CTR预估场景中即为商品此刻的点击率）

#### 2.1 Cumulative Gain
于是我们似乎有了一个粗糙的标准：
$$ Cumulative~Gain = \sum_{i=1}^{n} ItemScore_i $$

这里的$$Cumulative~Gain$$我们称之为累加增益，即所有商品的价值评分综合，用来衡量所有商品带来的价值。但当我们使用这个指标对算法A和算法B的排序进行计算。
发现算法A的累加增益与算法B相同：

$$ Cumulative~Gain_A = 5 + 1 + 3 + 2 + 4 = 15 $$

$$ Cumulative~Gain_B = 5 + 3 + 4 + 2 + 1 = 15 $$

看上去这个指标并不能评估排序好坏，我们需要进一步改进。


#### 2.2 Discounted Cumulative Gain
$$Cumulative~Gain$$仅仅考虑了商品的价值评分，并没有考虑每个商品的实际位置。位置越靠后的商品曝光机会处于劣势，如果排序算法将高价值的商品放到了靠后的位置，需要得到惩罚，
相反如果将高价值的商品放到了靠前的位置，需要得到奖励。

基于以上想法，尝试改进$$Cumulative~Gain$$：

$$ Discounted~Cumulative~Gain = \sum_{i=1}^{n} \frac{ItemScore_i}{log_2(i+1)} $$

实际应用场景中，为了增加$$ItemScore$$的影响，一般采用：

$$ Discounted~Cumulative~Gain = \sum_{i=1}^{n} \frac{2^{ItemScore_i} - 1}{log_2(i+1)} $$

在这个标准下，重新计算算法A与B的排序得分：

$$ Discounted~Cumulative~Gain_A = \frac{2^5 - 1}{log_2(1 + 1)} + \frac{2^1 - 1}{log_2(2+ 1)} + \frac{2^3 - 1}{log_2(3 + 1)} + \frac{2^2 - 1}{log_2(4 + 1)} + \frac{2^4 - 1}{log_2(5 + 1)} \approx 42.225751536309765$$

$$ Discounted~Cumulative~Gain_B = \frac{2^5 - 1}{log_2(1 + 1)} + \frac{2^3 - 1}{log_2(2+ 1)} + \frac{2^4 - 1}{log_2(3 + 1)} + \frac{2^2 - 1}{log_2(4 + 1)} + \frac{2^1 - 1}{log_2(5 + 1)} \approx 44.595390756454925$$

#### 2.3 Ideal Discounted Cumulative Gain
有了以上标准，我们同时计算一下最理想的排序$$[5,4,3,2,1]$$的$$Discounted~Cumulative~Gain$$。

这里我们称之为$$Discounted~Cumulative~Gain_{ideal}$$，即理想折损累加增益：

$$Discounted~Cumulative~Gain_{ideal} = \frac{2^5 - 1}{log_2(1 + 1)} + \frac{2^4 - 1}{log_2(2+ 1)} + \frac{2^3 - 1}{log_2(3 + 1)} + \frac{2^2 - 1}{log_2(4 + 1)} + \frac{2^1 - 1}{log_2(5 + 1)} \approx  45.64282878502658$$



#### 2.4 Normalized Discounted Cumulative Gain
最后，为了衡量算法A与算法B产生的结果与理想结果相差多少，我们引入了$$Normalized~Discounted~Cumulative~Gain$$，即$$NDCG$$。

$$NDCG = \frac{DCG}{IDCG}$$

现在，我们分别计算一下算法A与算法B产生的结果的$$NDCG$$。

$$NDCG@5_A = \frac{DCG_A}{IDCG} = 42.225751536309765 / 45.64282878502658 \approx 0.9251$$

$$NDCG@5_B = \frac{DCG_B}{IDCG} = 44.595390756454925 / 45.64282878502658 \approx 0.9771$$

至此我们使用$$NDCG$$指标衡量了算法A与算法B产生的排序结果的优劣，$$NDCG@5_B  > NDCG@5_A$$, 故针对口红排序这一次搜索结果，算法B的排序更优，这也与我们对两个排序的肉眼直觉相符合。

实际应用场景中，我们需要评判更长更复杂的排序，肉眼可能无法做出准确的直觉判断，这时候$$NDCG$$能够公平准确的对排序进行评估。

由于用户的注意力有限，实际Ranking问题中，我们可能仅仅只关注头部元素的排序，而忽略掉尾部的排序效果，此时使用$$NDCG@i$$表示头部$$i$$个元素的$$NDCG$$值

### 3. 总结
$$NDCG$$指标在信息检索、推荐系统的排序任务，相关性任务中有广泛的应用。